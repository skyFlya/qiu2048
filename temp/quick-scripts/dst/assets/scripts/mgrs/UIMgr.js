
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/mgrs/UIMgr.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '14376qdSO1HEqisl6XkkSE5', 'UIMgr');
// scripts/mgrs/UIMgr.ts

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.UIMgr = void 0;
var App_1 = require("../app/App");
var EventIDCfg_1 = require("../cfg/EventIDCfg");
var UIBase_1 = require("../ui/UIBase");
var EventMgr_1 = require("./EventMgr");
var UIMgr = /** @class */ (function () {
    function UIMgr() {
        this._loadingIds = [];
        this._nodeList = cc.js.createMap();
        this._waittingDisplayList = [];
        this._curDisplay = null;
        this._uiList = [];
        this._openUINameList = [];
    }
    UIMgr.getInstance = function () {
        if (UIMgr._instance == null) {
            UIMgr._instance = new UIMgr();
        }
        return UIMgr._instance;
    };
    UIMgr.destroyInstance = function () {
        if (UIMgr._instance) {
            UIMgr._instance = null;
        }
    };
    UIMgr.prototype.openUI = function (name, callback) {
        var cfg = App_1.App.uiCfgMgr.getCfg(name);
        if (!cfg) {
            cc.error('未配置：' + name);
            return;
        }
        var displayId = 0;
        if (this._nodeList[name] && cc.isValid(this._nodeList[name])) {
            this._openUINameList.push(name);
            if (cfg.needWait) {
                if (this._curDisplay == null) {
                    displayId = ++UIMgr._curDisplayId;
                    this._curDisplay = {
                        name: name,
                        callback: callback
                    };
                    this.showUI(name, callback, displayId);
                }
                else {
                    if (this._curDisplay.name == name) {
                        cc.error('重复显示：' + name);
                        return;
                    }
                    for (var i = 0; i < this._waittingDisplayList.length; i++) {
                        if (this._waittingDisplayList[i].name == name) {
                            cc.error('重复显示：' + name);
                            return;
                        }
                    }
                    this._waittingDisplayList.push({
                        name: name,
                        callback: callback
                    });
                }
            }
            else {
                this.showUI(name, callback, displayId);
            }
        }
        else {
            // 加载资源
            if (cfg.preloadRes && cfg.preloadRes.length > 0) {
                this._openUINameList.push(name);
                if (cfg.needWait) {
                    if (this._curDisplay == null) {
                        displayId = ++UIMgr._curDisplayId;
                        this._curDisplay = {
                            name: name,
                            callback: callback
                        };
                    }
                    else {
                        if (this._curDisplay.name == name) {
                            cc.error('重复显示：' + name);
                            return;
                        }
                        for (var i = 0; i < this._waittingDisplayList.length; i++) {
                            if (this._waittingDisplayList[i].name == name) {
                                cc.error('重复显示：' + name);
                                return;
                            }
                        }
                        this._waittingDisplayList.push({
                            name: name,
                            callback: callback
                        });
                    }
                }
                this.loadRes(name, callback, displayId);
            }
            else {
                cc.error('未配置资源：' + name);
            }
        }
    };
    UIMgr.prototype.closeUI = function (name, isDestroy, callback) {
        var _this = this;
        if (isDestroy === void 0) { isDestroy = false; }
        var cfg = App_1.App.uiCfgMgr.getCfg(name);
        if (!cfg) {
            cc.error('未配置' + cfg);
            return;
        }
        var idx = this._openUINameList.indexOf(name);
        if (-1 != idx) {
            this._openUINameList.splice(idx, 1);
        }
        var isExits = false;
        if (cfg.needWait) {
            if (this._curDisplay && this._curDisplay.name == name) {
                this._curDisplay = null;
                isExits = true;
            }
            for (var i = 0; i < this._waittingDisplayList.length; i++) {
                if (this._waittingDisplayList[i].name == name) {
                    this._waittingDisplayList.splice(i, 1);
                    isExits = true;
                    break;
                }
            }
        }
        var node = this._nodeList[name];
        if (node) {
            var uiBase_1 = node.getComponent(UIBase_1.default);
            var idx_1 = this._uiList.indexOf(uiBase_1);
            if (isDestroy) {
                this._nodeList[name] = null;
            }
            if (idx_1 != -1) {
                this._uiList.splice(idx_1, 1);
                uiBase_1.hide(function () {
                    if (isDestroy) {
                        node.removeFromParent();
                        node.destroy();
                    }
                    _this.closeAndShowNext(uiBase_1, name, cfg.needWait, callback);
                });
            }
            else {
                this.closeAndShowNext(null, name, cfg.needWait, callback);
            }
        }
        else if (isExits) {
            this.closeAndShowNext(null, name, cfg.needWait, callback);
        }
    };
    UIMgr.prototype.findUI = function (name) {
        var node = this._nodeList[name];
        if (node) {
            var uiBase = node.getComponent(UIBase_1.default);
            var idx = this._uiList.indexOf(uiBase);
            if (idx != -1) {
                return uiBase;
            }
        }
        return null;
    };
    UIMgr.prototype.showUI = function (name, callback, displayId) {
        var cfg = App_1.App.uiCfgMgr.getCfg(name);
        if (!cfg) {
            cc.error('未配置' + cfg);
            return;
        }
        if (-1 == this._openUINameList.indexOf(name)) {
            return;
        }
        if (cfg.needWait) {
            if (!this._curDisplay || displayId != UIMgr._curDisplayId) {
                return;
            }
        }
        cc.log("show " + name);
        var uiBase = this._nodeList[name].getComponent(UIBase_1.default);
        var idx = this._uiList.indexOf(uiBase);
        if (idx != -1) {
            this._uiList.splice(idx, 1);
        }
        this._uiList.push(uiBase);
        uiBase.node.parent = cc.find("Canvas/UIRoot");
        uiBase.node.zIndex = cfg.zIndex;
        uiBase.show(function () { });
        callback && callback(uiBase);
        EventMgr_1.EventMgr.emit(EventIDCfg_1.EventIDCfg.PANNLE_SHOW, { name: name });
    };
    UIMgr.prototype.closeAndShowNext = function (uiBase, name, tryShowNext, callback) {
        callback && callback(uiBase);
        EventMgr_1.EventMgr.emit(EventIDCfg_1.EventIDCfg.PANNEL_CLOSE, { name: name });
        tryShowNext && this.tryShowNextUI();
    };
    UIMgr.prototype.tryShowNextUI = function () {
        if (this._curDisplay == null && this._waittingDisplayList.length > 0) {
            var cfg = this._waittingDisplayList.shift();
            var displayId = ++UIMgr._curDisplayId;
            this._curDisplay = {
                name: cfg.name,
                callback: cfg.callback
            };
            if (this._nodeList[cfg.name] && cc.isValid(this._nodeList[cfg.name])) {
                this.showUI(this._curDisplay.name, this._curDisplay.callback, displayId);
            }
            else {
                // 加载
                this.loadRes(cfg.name, cfg.callback, displayId);
            }
        }
    };
    UIMgr.prototype.loadRes = function (name, callback, displayId) {
        var _this = this;
        var cfg = App_1.App.uiCfgMgr.getCfg(name);
        if (!cfg) {
            cc.error('未配置：' + name);
            return;
        }
        var id = ++UIMgr._loadingId;
        this._loadingIds.push(id);
        var length = cfg.preloadRes.length;
        var loaded = 0;
        var isLoadedError = false;
        for (var i = 0; i < length; i++) {
            cc.loader.loadRes(cfg.preloadRes[i].url, cfg.preloadRes[i].type, function (error, res) {
                if (error) {
                    isLoadedError = true;
                    cc.error(error.message || error);
                }
                loaded++;
                if (loaded == length) {
                    var idx = _this._loadingIds.indexOf(id);
                    if (idx != -1) {
                        _this._loadingIds.splice(idx, 1);
                        if (!isLoadedError) {
                            if (!_this._nodeList[name] || !cc.isValid(_this._nodeList[name])) {
                                var prefab = cc.loader.getRes(cfg.ui, cc.Prefab);
                                _this._nodeList[name] = cc.instantiate(prefab);
                            }
                            if (-1 == _this._openUINameList.indexOf(name)) {
                                return;
                            }
                            _this.showUI(name, callback, displayId);
                        }
                    }
                }
            });
        }
    };
    UIMgr.prototype.clear = function () {
        var uiRoot = cc.find("Canvas/UIRoot");
        if (uiRoot) {
            uiRoot.removeAllChildren();
        }
        this._loadingIds = [];
        this._nodeList = cc.js.createMap();
        this._waittingDisplayList = [];
        this._curDisplay = null;
        this._uiList = [];
        this._openUINameList = [];
    };
    /**
     * 是否已经打开
     * @param name
     */
    UIMgr.prototype.isOpend = function (name) {
        var idx = this._openUINameList.indexOf(name);
        if (-1 != idx) {
            return true;
        }
        if (this._curDisplay && this._curDisplay.name == name) {
            return true;
        }
        return false;
    };
    /**
     * 是否等待打开
     */
    UIMgr.prototype.isWaittingOpen = function (name) {
        for (var i = 0; i < this._waittingDisplayList.length; i++) {
            if (this._waittingDisplayList[i].name == name) {
                return true;
            }
        }
        return false;
    };
    UIMgr.prototype.isOpenedOrWaittingOpen = function (name) {
        return this.isOpend(name) || this.isWaittingOpen(name);
    };
    UIMgr._instance = null;
    UIMgr._loadingId = 0;
    UIMgr._curDisplayId = 0;
    return UIMgr;
}());
exports.UIMgr = UIMgr;

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcbWdyc1xcVUlNZ3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0NBQWlDO0FBQ2pDLGdEQUErQztBQUMvQyx1Q0FBa0M7QUFDbEMsdUNBQXNDO0FBR3RDO0lBQUE7UUFJWSxnQkFBVyxHQUFrQixFQUFFLENBQUM7UUFDaEMsY0FBUyxHQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDdEMseUJBQW9CLEdBQWUsRUFBRSxDQUFDO1FBQ3RDLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLFlBQU8sR0FBa0IsRUFBRSxDQUFDO1FBQzVCLG9CQUFlLEdBQWtCLEVBQUUsQ0FBQztJQTJSaEQsQ0FBQztJQXpSaUIsaUJBQVcsR0FBekI7UUFDSSxJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksSUFBSSxFQUFFO1lBQ3pCLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztTQUNqQztRQUNELE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUMzQixDQUFDO0lBRWEscUJBQWUsR0FBN0I7UUFDSSxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUU7WUFDakIsS0FBSyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7U0FDMUI7SUFDTCxDQUFDO0lBRU0sc0JBQU0sR0FBYixVQUFjLElBQVksRUFBRSxRQUFtQztRQUMzRCxJQUFNLEdBQUcsR0FBRyxTQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ04sRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDeEIsT0FBTztTQUNWO1FBQ0QsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUMxRCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2QsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksRUFBRTtvQkFDMUIsU0FBUyxHQUFHLEVBQUUsS0FBSyxDQUFDLGFBQWEsQ0FBQztvQkFDbEMsSUFBSSxDQUFDLFdBQVcsR0FBRzt3QkFDZixJQUFJLEVBQUUsSUFBSTt3QkFDVixRQUFRLEVBQUUsUUFBUTtxQkFDckIsQ0FBQTtvQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7aUJBQzFDO3FCQUFNO29CQUNILElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO3dCQUMvQixFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQzt3QkFDekIsT0FBTztxQkFDVjtvQkFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTt3QkFDdkQsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTs0QkFDM0MsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUM7NEJBQ3pCLE9BQU87eUJBQ1Y7cUJBQ0o7b0JBQ0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQzt3QkFDM0IsSUFBSSxFQUFFLElBQUk7d0JBQ1YsUUFBUSxFQUFFLFFBQVE7cUJBQ3JCLENBQUMsQ0FBQztpQkFDTjthQUNKO2lCQUFNO2dCQUNILElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUMxQztTQUNKO2FBQU07WUFDSCxPQUFPO1lBQ1AsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hDLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRTtvQkFDZCxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxFQUFFO3dCQUMxQixTQUFTLEdBQUcsRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDO3dCQUNsQyxJQUFJLENBQUMsV0FBVyxHQUFHOzRCQUNmLElBQUksRUFBRSxJQUFJOzRCQUNWLFFBQVEsRUFBRSxRQUFRO3lCQUNyQixDQUFBO3FCQUNKO3lCQUFNO3dCQUNILElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFOzRCQUMvQixFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQzs0QkFDekIsT0FBTzt5QkFDVjt3QkFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTs0QkFDdkQsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTtnQ0FDM0MsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUM7Z0NBQ3pCLE9BQU87NkJBQ1Y7eUJBQ0o7d0JBQ0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQzs0QkFDM0IsSUFBSSxFQUFFLElBQUk7NEJBQ1YsUUFBUSxFQUFFLFFBQVE7eUJBQ3JCLENBQUMsQ0FBQztxQkFDTjtpQkFDSjtnQkFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDM0M7aUJBQU07Z0JBQ0gsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUM7YUFDN0I7U0FDSjtJQUNMLENBQUM7SUFFTSx1QkFBTyxHQUFkLFVBQWUsSUFBWSxFQUFFLFNBQTBCLEVBQUUsUUFBbUM7UUFBNUYsaUJBZ0RDO1FBaEQ0QiwwQkFBQSxFQUFBLGlCQUEwQjtRQUNuRCxJQUFNLEdBQUcsR0FBRyxTQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ04sRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDdEIsT0FBTztTQUNWO1FBQ0QsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDWCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLE9BQU8sR0FBWSxLQUFLLENBQUM7UUFDN0IsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFO1lBQ2QsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTtnQkFDbkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLE9BQU8sR0FBRyxJQUFJLENBQUM7YUFDbEI7WUFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdkQsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTtvQkFDM0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZDLE9BQU8sR0FBRyxJQUFJLENBQUM7b0JBQ2YsTUFBTTtpQkFDVDthQUNKO1NBQ0o7UUFFRCxJQUFNLElBQUksR0FBWSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLElBQUksSUFBSSxFQUFFO1lBQ04sSUFBTSxRQUFNLEdBQVcsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBTSxDQUFDLENBQUM7WUFDakQsSUFBTSxLQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsUUFBTSxDQUFDLENBQUM7WUFDekMsSUFBSSxTQUFTLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDL0I7WUFDRCxJQUFJLEtBQUcsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLFFBQU0sQ0FBQyxJQUFJLENBQUM7b0JBQ1IsSUFBSSxTQUFTLEVBQUU7d0JBQ1gsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7d0JBQ3hCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztxQkFDbEI7b0JBQ0QsS0FBSSxDQUFDLGdCQUFnQixDQUFDLFFBQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDaEUsQ0FBQyxDQUFDLENBQUM7YUFDTjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQzdEO1NBQ0o7YUFBTSxJQUFJLE9BQU8sRUFBRTtZQUNoQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQzdEO0lBQ0wsQ0FBQztJQUVNLHNCQUFNLEdBQWIsVUFBYyxJQUFZO1FBQ3RCLElBQU0sSUFBSSxHQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsSUFBSSxJQUFJLEVBQUU7WUFDTixJQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFNLENBQUMsQ0FBQztZQUNqRCxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDWCxPQUFPLE1BQU0sQ0FBQTthQUNoQjtTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVPLHNCQUFNLEdBQWQsVUFBZSxJQUFZLEVBQUUsUUFBa0MsRUFBRSxTQUFpQjtRQUM5RSxJQUFNLEdBQUcsR0FBRyxTQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ04sRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDdEIsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMxQyxPQUFPO1NBQ1Y7UUFFRCxJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxTQUFTLElBQUksS0FBSyxDQUFDLGFBQWEsRUFBRTtnQkFDdkQsT0FBTzthQUNWO1NBQ0o7UUFDRCxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQztRQUV2QixJQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxnQkFBTSxDQUFDLENBQUM7UUFDakUsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDL0I7UUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0IsbUJBQVEsQ0FBQyxJQUFJLENBQUMsdUJBQVUsQ0FBQyxXQUFXLEVBQUUsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU8sZ0NBQWdCLEdBQXhCLFVBQXlCLE1BQWMsRUFBRSxJQUFZLEVBQUUsV0FBb0IsRUFBRSxRQUFrQztRQUMzRyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLG1CQUFRLENBQUMsSUFBSSxDQUFDLHVCQUFVLENBQUMsWUFBWSxFQUFFLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDckQsV0FBVyxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRU8sNkJBQWEsR0FBckI7UUFDSSxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xFLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM5QyxJQUFNLFNBQVMsR0FBRyxFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUM7WUFDeEMsSUFBSSxDQUFDLFdBQVcsR0FBRztnQkFDZixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7Z0JBQ2QsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRO2FBQ3pCLENBQUE7WUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDbEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUM1RTtpQkFBTTtnQkFDSCxLQUFLO2dCQUNMLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ25EO1NBQ0o7SUFDTCxDQUFDO0lBRU8sdUJBQU8sR0FBZixVQUFnQixJQUFZLEVBQUUsUUFBa0MsRUFBRSxTQUFpQjtRQUFuRixpQkFvQ0M7UUFuQ0csSUFBTSxHQUFHLEdBQUcsU0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNOLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ3hCLE9BQU87U0FDVjtRQUNELElBQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUM5QixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxQixJQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQztRQUNyQyxJQUFJLE1BQU0sR0FBVyxDQUFDLENBQUM7UUFDdkIsSUFBSSxhQUFhLEdBQVksS0FBSyxDQUFDO1FBQ25DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDN0IsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsVUFBQyxLQUFZLEVBQUUsR0FBUTtnQkFDcEYsSUFBSSxLQUFLLEVBQUU7b0JBQ1AsYUFBYSxHQUFHLElBQUksQ0FBQztvQkFDckIsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxDQUFDO2lCQUNwQztnQkFDRCxNQUFNLEVBQUUsQ0FBQztnQkFDVCxJQUFJLE1BQU0sSUFBSSxNQUFNLEVBQUU7b0JBQ2xCLElBQU0sR0FBRyxHQUFHLEtBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUN6QyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsRUFBRTt3QkFDWCxLQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7d0JBQ2hDLElBQUksQ0FBQyxhQUFhLEVBQUU7NEJBQ2hCLElBQUksQ0FBQyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7Z0NBQzVELElBQU0sTUFBTSxHQUFjLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dDQUM5RCxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7NkJBQ2pEOzRCQUNELElBQUksQ0FBQyxDQUFDLElBQUksS0FBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0NBQzFDLE9BQU87NkJBQ1Y7NEJBQ0QsS0FBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO3lCQUMxQztxQkFDSjtpQkFDSjtZQUNMLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDO0lBRU0scUJBQUssR0FBWjtRQUNJLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDeEMsSUFBSSxNQUFNLEVBQUU7WUFDUixNQUFNLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztTQUM5QjtRQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFRDs7O09BR0c7SUFDSyx1QkFBTyxHQUFmLFVBQWdCLElBQVk7UUFDeEIsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDWCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRTtZQUNuRCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ00sOEJBQWMsR0FBdEIsVUFBdUIsSUFBWTtRQUNoQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN2RCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO2dCQUMzQyxPQUFPLElBQUksQ0FBQzthQUNmO1NBQ0o7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRU0sc0NBQXNCLEdBQTdCLFVBQThCLElBQVk7UUFDdEMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQWpTYyxlQUFTLEdBQVUsSUFBSSxDQUFDO0lBQ3hCLGdCQUFVLEdBQVcsQ0FBQyxDQUFDO0lBQ3ZCLG1CQUFhLEdBQVcsQ0FBQyxDQUFDO0lBaVM3QyxZQUFDO0NBcFNELEFBb1NDLElBQUE7QUFwU1ksc0JBQUsiLCJmaWxlIjoiIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi4vYXBwL0FwcFwiO1xyXG5pbXBvcnQgeyBFdmVudElEQ2ZnIH0gZnJvbSBcIi4uL2NmZy9FdmVudElEQ2ZnXCI7XHJcbmltcG9ydCBVSUJhc2UgZnJvbSBcIi4uL3VpL1VJQmFzZVwiO1xyXG5pbXBvcnQgeyBFdmVudE1nciB9IGZyb20gXCIuL0V2ZW50TWdyXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFVJTWdyIHtcclxuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogVUlNZ3IgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2xvYWRpbmdJZDogbnVtYmVyID0gMDtcclxuICAgIHByaXZhdGUgc3RhdGljIF9jdXJEaXNwbGF5SWQ6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIF9sb2FkaW5nSWRzOiBBcnJheTxudW1iZXI+ID0gW107XHJcbiAgICBwcml2YXRlIF9ub2RlTGlzdDogT2JqZWN0ID0gY2MuanMuY3JlYXRlTWFwKCk7XHJcbiAgICBwcml2YXRlIF93YWl0dGluZ0Rpc3BsYXlMaXN0OiBBcnJheTxhbnk+ID0gW107XHJcbiAgICBwcml2YXRlIF9jdXJEaXNwbGF5OiBhbnkgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBfdWlMaXN0OiBBcnJheTxVSUJhc2U+ID0gW107XHJcbiAgICBwcml2YXRlIF9vcGVuVUlOYW1lTGlzdDogQXJyYXk8c3RyaW5nPiA9IFtdO1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogVUlNZ3Ige1xyXG4gICAgICAgIGlmIChVSU1nci5faW5zdGFuY2UgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBVSU1nci5faW5zdGFuY2UgPSBuZXcgVUlNZ3IoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFVJTWdyLl9pbnN0YW5jZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGRlc3Ryb3lJbnN0YW5jZSgpOnZvaWQge1xyXG4gICAgICAgIGlmIChVSU1nci5faW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgVUlNZ3IuX2luc3RhbmNlID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9wZW5VSShuYW1lOiBzdHJpbmcsIGNhbGxiYWNrPzogKHVpQmFzZTogVUlCYXNlKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgY2ZnID0gQXBwLnVpQ2ZnTWdyLmdldENmZyhuYW1lKTtcclxuICAgICAgICBpZiAoIWNmZykge1xyXG4gICAgICAgICAgICBjYy5lcnJvcign5pyq6YWN572u77yaJyArIG5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBkaXNwbGF5SWQgPSAwO1xyXG4gICAgICAgIGlmICh0aGlzLl9ub2RlTGlzdFtuYW1lXSAmJiBjYy5pc1ZhbGlkKHRoaXMuX25vZGVMaXN0W25hbWVdKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9vcGVuVUlOYW1lTGlzdC5wdXNoKG5hbWUpO1xyXG4gICAgICAgICAgICBpZiAoY2ZnLm5lZWRXYWl0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fY3VyRGlzcGxheSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheUlkID0gKytVSU1nci5fY3VyRGlzcGxheUlkO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1ckRpc3BsYXkgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFja1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dVSShuYW1lLCBjYWxsYmFjaywgZGlzcGxheUlkKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2N1ckRpc3BsYXkubmFtZSA9PSBuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNjLmVycm9yKCfph43lpI3mmL7npLrvvJonICsgbmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl93YWl0dGluZ0Rpc3BsYXlMaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl93YWl0dGluZ0Rpc3BsYXlMaXN0W2ldLm5hbWUgPT0gbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2MuZXJyb3IoJ+mHjeWkjeaYvuekuu+8micgKyBuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0dGluZ0Rpc3BsYXlMaXN0LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2tcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1VJKG5hbWUsIGNhbGxiYWNrLCBkaXNwbGF5SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5Yqg6L296LWE5rqQXHJcbiAgICAgICAgICAgIGlmIChjZmcucHJlbG9hZFJlcyAmJiBjZmcucHJlbG9hZFJlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9vcGVuVUlOYW1lTGlzdC5wdXNoKG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNmZy5uZWVkV2FpdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jdXJEaXNwbGF5ID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheUlkID0gKytVSU1nci5fY3VyRGlzcGxheUlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJEaXNwbGF5ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFja1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2N1ckRpc3BsYXkubmFtZSA9PSBuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYy5lcnJvcign6YeN5aSN5pi+56S677yaJyArIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fd2FpdHRpbmdEaXNwbGF5TGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3dhaXR0aW5nRGlzcGxheUxpc3RbaV0ubmFtZSA9PSBuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2MuZXJyb3IoJ+mHjeWkjeaYvuekuu+8micgKyBuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdHRpbmdEaXNwbGF5TGlzdC5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2tcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkUmVzKG5hbWUsIGNhbGxiYWNrLCBkaXNwbGF5SWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY2MuZXJyb3IoJ+acqumFjee9rui1hOa6kO+8micgKyBuYW1lKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xvc2VVSShuYW1lOiBzdHJpbmcsIGlzRGVzdHJveTogYm9vbGVhbiA9IGZhbHNlLCBjYWxsYmFjaz86ICh1aUJhc2U6IFVJQmFzZSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGNmZyA9IEFwcC51aUNmZ01nci5nZXRDZmcobmFtZSk7XHJcbiAgICAgICAgaWYgKCFjZmcpIHtcclxuICAgICAgICAgICAgY2MuZXJyb3IoJ+acqumFjee9ricgKyBjZmcpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuX29wZW5VSU5hbWVMaXN0LmluZGV4T2YobmFtZSk7XHJcbiAgICAgICAgaWYgKC0xICE9IGlkeCkge1xyXG4gICAgICAgICAgICB0aGlzLl9vcGVuVUlOYW1lTGlzdC5zcGxpY2UoaWR4LCAxKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBpc0V4aXRzOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKGNmZy5uZWVkV2FpdCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fY3VyRGlzcGxheSAmJiB0aGlzLl9jdXJEaXNwbGF5Lm5hbWUgPT0gbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY3VyRGlzcGxheSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBpc0V4aXRzID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3dhaXR0aW5nRGlzcGxheUxpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl93YWl0dGluZ0Rpc3BsYXlMaXN0W2ldLm5hbWUgPT0gbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3dhaXR0aW5nRGlzcGxheUxpc3Quc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRXhpdHMgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBub2RlOiBjYy5Ob2RlID0gdGhpcy5fbm9kZUxpc3RbbmFtZV07XHJcbiAgICAgICAgaWYgKG5vZGUpIHtcclxuICAgICAgICAgICAgY29uc3QgdWlCYXNlOiBVSUJhc2UgPSBub2RlLmdldENvbXBvbmVudChVSUJhc2UpO1xyXG4gICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLl91aUxpc3QuaW5kZXhPZih1aUJhc2UpO1xyXG4gICAgICAgICAgICBpZiAoaXNEZXN0cm95KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9ub2RlTGlzdFtuYW1lXSA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGlkeCAhPSAtMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdWlMaXN0LnNwbGljZShpZHgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdWlCYXNlLmhpZGUoKCk9PntcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNEZXN0cm95KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlRnJvbVBhcmVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUFuZFNob3dOZXh0KHVpQmFzZSwgbmFtZSwgY2ZnLm5lZWRXYWl0LCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VBbmRTaG93TmV4dChudWxsLCBuYW1lLCBjZmcubmVlZFdhaXQsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoaXNFeGl0cykge1xyXG4gICAgICAgICAgICB0aGlzLmNsb3NlQW5kU2hvd05leHQobnVsbCwgbmFtZSwgY2ZnLm5lZWRXYWl0LCBjYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmaW5kVUkobmFtZTogc3RyaW5nKTogVUlCYXNlIHtcclxuICAgICAgICBjb25zdCBub2RlOiBjYy5Ob2RlID0gdGhpcy5fbm9kZUxpc3RbbmFtZV07XHJcbiAgICAgICAgaWYgKG5vZGUpIHtcclxuICAgICAgICAgICAgY29uc3QgdWlCYXNlOiBVSUJhc2UgPSBub2RlLmdldENvbXBvbmVudChVSUJhc2UpO1xyXG4gICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLl91aUxpc3QuaW5kZXhPZih1aUJhc2UpO1xyXG4gICAgICAgICAgICBpZiAoaWR4ICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdWlCYXNlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaG93VUkobmFtZTogc3RyaW5nLCBjYWxsYmFjazogKHVpQmFzZTogVUlCYXNlKSA9PiB2b2lkLCBkaXNwbGF5SWQ6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGNmZyA9IEFwcC51aUNmZ01nci5nZXRDZmcobmFtZSk7XHJcbiAgICAgICAgaWYgKCFjZmcpIHtcclxuICAgICAgICAgICAgY2MuZXJyb3IoJ+acqumFjee9ricgKyBjZmcpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgtMSA9PSB0aGlzLl9vcGVuVUlOYW1lTGlzdC5pbmRleE9mKG5hbWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjZmcubmVlZFdhaXQpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLl9jdXJEaXNwbGF5IHx8IGRpc3BsYXlJZCAhPSBVSU1nci5fY3VyRGlzcGxheUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2MubG9nKFwic2hvdyBcIiArIG5hbWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHVpQmFzZTogVUlCYXNlID0gdGhpcy5fbm9kZUxpc3RbbmFtZV0uZ2V0Q29tcG9uZW50KFVJQmFzZSk7XHJcbiAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5fdWlMaXN0LmluZGV4T2YodWlCYXNlKTtcclxuICAgICAgICBpZiAoaWR4ICE9IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3VpTGlzdC5zcGxpY2UoaWR4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fdWlMaXN0LnB1c2godWlCYXNlKTtcclxuICAgICAgICB1aUJhc2Uubm9kZS5wYXJlbnQgPSBjYy5maW5kKFwiQ2FudmFzL1VJUm9vdFwiKTtcclxuICAgICAgICB1aUJhc2Uubm9kZS56SW5kZXggPSBjZmcuekluZGV4O1xyXG4gICAgICAgIHVpQmFzZS5zaG93KCgpPT57fSk7XHJcbiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2sodWlCYXNlKTtcclxuICAgICAgICBFdmVudE1nci5lbWl0KEV2ZW50SURDZmcuUEFOTkxFX1NIT1csIHtuYW1lOiBuYW1lfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbG9zZUFuZFNob3dOZXh0KHVpQmFzZTogVUlCYXNlLCBuYW1lOiBzdHJpbmcsIHRyeVNob3dOZXh0OiBib29sZWFuLCBjYWxsYmFjazogKHVpQmFzZTogVUlCYXNlKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2sodWlCYXNlKTtcclxuICAgICAgICBFdmVudE1nci5lbWl0KEV2ZW50SURDZmcuUEFOTkVMX0NMT1NFLCB7bmFtZTogbmFtZX0pO1xyXG4gICAgICAgIHRyeVNob3dOZXh0ICYmIHRoaXMudHJ5U2hvd05leHRVSSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdHJ5U2hvd05leHRVSSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5fY3VyRGlzcGxheSA9PSBudWxsICYmIHRoaXMuX3dhaXR0aW5nRGlzcGxheUxpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBjZmcgPSB0aGlzLl93YWl0dGluZ0Rpc3BsYXlMaXN0LnNoaWZ0KCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlJZCA9ICsrVUlNZ3IuX2N1ckRpc3BsYXlJZDtcclxuICAgICAgICAgICAgdGhpcy5fY3VyRGlzcGxheSA9IHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IGNmZy5uYW1lLFxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6IGNmZy5jYWxsYmFja1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9ub2RlTGlzdFtjZmcubmFtZV0gJiYgY2MuaXNWYWxpZCh0aGlzLl9ub2RlTGlzdFtjZmcubmFtZV0pKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dVSSh0aGlzLl9jdXJEaXNwbGF5Lm5hbWUsIHRoaXMuX2N1ckRpc3BsYXkuY2FsbGJhY2ssIGRpc3BsYXlJZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyDliqDovb1cclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZFJlcyhjZmcubmFtZSwgY2ZnLmNhbGxiYWNrLCBkaXNwbGF5SWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbG9hZFJlcyhuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAodWlCYXNlOiBVSUJhc2UpID0+IHZvaWQsIGRpc3BsYXlJZDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgY2ZnID0gQXBwLnVpQ2ZnTWdyLmdldENmZyhuYW1lKTtcclxuICAgICAgICBpZiAoIWNmZykge1xyXG4gICAgICAgICAgICBjYy5lcnJvcign5pyq6YWN572u77yaJyArIG5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlkID0gKytVSU1nci5fbG9hZGluZ0lkO1xyXG4gICAgICAgIHRoaXMuX2xvYWRpbmdJZHMucHVzaChpZCk7XHJcbiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2ZnLnByZWxvYWRSZXMubGVuZ3RoO1xyXG4gICAgICAgIGxldCBsb2FkZWQ6IG51bWJlciA9IDA7XHJcbiAgICAgICAgbGV0IGlzTG9hZGVkRXJyb3I6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNjLmxvYWRlci5sb2FkUmVzKGNmZy5wcmVsb2FkUmVzW2ldLnVybCwgY2ZnLnByZWxvYWRSZXNbaV0udHlwZSwgKGVycm9yOiBFcnJvciwgcmVzOiBhbnkpPT57XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc0xvYWRlZEVycm9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBjYy5lcnJvcihlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcclxuICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICBsb2FkZWQrKztcclxuICAgICAgICAgICAgICAgIGlmIChsb2FkZWQgPT0gbGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5fbG9hZGluZ0lkcy5pbmRleE9mKGlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWRpbmdJZHMuc3BsaWNlKGlkeCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNMb2FkZWRFcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9ub2RlTGlzdFtuYW1lXSB8fCAhY2MuaXNWYWxpZCh0aGlzLl9ub2RlTGlzdFtuYW1lXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmVmYWI6IGNjLlByZWZhYiA9IGNjLmxvYWRlci5nZXRSZXMoY2ZnLnVpLCBjYy5QcmVmYWIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX25vZGVMaXN0W25hbWVdID0gY2MuaW5zdGFudGlhdGUocHJlZmFiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA9PSB0aGlzLl9vcGVuVUlOYW1lTGlzdC5pbmRleE9mKG5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93VUkobmFtZSwgY2FsbGJhY2ssIGRpc3BsYXlJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xlYXIoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgdWlSb290ID0gY2MuZmluZChcIkNhbnZhcy9VSVJvb3RcIik7XHJcbiAgICAgICAgaWYgKHVpUm9vdCkge1xyXG4gICAgICAgICAgICB1aVJvb3QucmVtb3ZlQWxsQ2hpbGRyZW4oKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fbG9hZGluZ0lkcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuX25vZGVMaXN0ID0gY2MuanMuY3JlYXRlTWFwKCk7XHJcbiAgICAgICAgdGhpcy5fd2FpdHRpbmdEaXNwbGF5TGlzdCA9IFtdO1xyXG4gICAgICAgIHRoaXMuX2N1ckRpc3BsYXkgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuX3VpTGlzdCA9IFtdO1xyXG4gICAgICAgIHRoaXMuX29wZW5VSU5hbWVMaXN0ID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmmK/lkKblt7Lnu4/miZPlvIBcclxuICAgICAqIEBwYXJhbSBuYW1lIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGlzT3BlbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5fb3BlblVJTmFtZUxpc3QuaW5kZXhPZihuYW1lKTtcclxuICAgICAgICBpZiAoLTEgIT0gaWR4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5fY3VyRGlzcGxheSAmJiB0aGlzLl9jdXJEaXNwbGF5Lm5hbWUgPT0gbmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5piv5ZCm562J5b6F5omT5byAXHJcbiAgICAgKi9cclxuICAgICBwcml2YXRlIGlzV2FpdHRpbmdPcGVuKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fd2FpdHRpbmdEaXNwbGF5TGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fd2FpdHRpbmdEaXNwbGF5TGlzdFtpXS5uYW1lID09IG5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNPcGVuZWRPcldhaXR0aW5nT3BlbihuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pc09wZW5kKG5hbWUpIHx8IHRoaXMuaXNXYWl0dGluZ09wZW4obmFtZSk7XHJcbiAgICB9XHJcblxyXG59Il19